<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Facturación</title>
    <link rel="stylesheet" href="/static/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
   </head>

   <nav class="navbar">
    <ul class="menu">
        <li><a href="/index">Subir Archivos</a></li>
        <li><a href="/dashboard">Dashboard</a></li>
        <li><a href="/reportes.anteriores">Reportes</a></li>
    </ul>
    <!-- Menú de usuario en la esquina derecha -->
    <div class="user-info">
        <i class="fas fa-user"></i> <!-- Ícono de usuario -->
        <span>{{ session['user_email'] }}</span> <!-- Correo del usuario -->
        <a href="/logout" class="logout-icon">
            <i class="fas fa-sign-out-alt"></i> <!-- Ícono de cerrar sesión -->
        </a>
    </div>
</nav>
   
</nav>
<body class="bodydashboard">
    <div class="dashboard-container">
        <!-- Sección de Filtros -->
        <div class="filters-section">
            <form action="{{ url_for('dashboard') }}" method="get" class="filters-form">
                <div class="filter-group">
                    <label for="fecha_inicio">Fecha Inicio:</label>
                    <input type="date" id="fecha_inicio" name="fecha_inicio" value="{{ fecha_inicio }}">
                </div>

                <div class="filter-group">
                    <label for="fecha_fin">Fecha Fin:</label>
                    <input type="date" id="fecha_fin" name="fecha_fin" value="{{ fecha_fin }}">
                </div>

                
                <div class="filter-group">
                    <label for="clientes-select" style="font-weight: bold;">Clientes:</label>
                    <span id="selected-client" style="cursor: pointer; color: #333; border: 1px solid #ddd; padding: 10px; display: inline-block; border-radius: 4px; width: 100%; text-align: left; margin-bottom: 5px;">Selecciona clientes</span>
                    <div id="clientes-list" class="checkbox-container hidden">
                        {% for cliente in clientes_unicos %}
                        <div class="checkbox-item" data-cliente="{{ cliente }}">
                            <input type="checkbox" name="clientes[]" value="{{ cliente }}" class="hidden-checkbox"
                                {% if cliente in clientes_filtro %}checked{% endif %}>
                            <label>{{ cliente }}</label>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                
                <div class="filter-group">
                    <label for="rango_monto">Rango de Monto:</label>
                    <select id="rango_monto" name="rango_monto">
                        <option value="">Todos los montos</option>
                        <option value="0-1000" {% if rango_monto == '0-1000' %}selected{% endif %}>$0 - $1,000</option>
                        <option value="1000-5000" {% if rango_monto == '1000-5000' %}selected{% endif %}>$1,000 - $5,000</option>
                        <option value="5000-10000" {% if rango_monto == '5000-10000' %}selected{% endif %}>$5,000 - $10,000</option>
                        <option value="10000-50000" {% if rango_monto == '10000-50000' %}selected{% endif %}>$10,000 - $50,000</option>
                        <option value="50000-100000" {% if rango_monto == '50000-100000' %}selected{% endif %}>$50,000+</option>
                    </select>
                </div>

                <button type="submit" class="filter-button">Aplicar Filtros</button>
                <a href="{{ url_for('dashboard') }}" class="reset-button">Resetear Filtros</a>
            </form>
        </div>

        <!-- Tarjetas de Resumen -->
        <div class="summary-cards">
            <div class="card">
                <h3>Total Facturas</h3>
                <p>{{ total_facturas }}</p>
            </div>
            <div class="card">
                <h3>Total Ventas</h3>
                <p>${{ "%.2f"|format(total_ventas) }}</p>
            </div>
            <div class="card">
                <h3>Promedio por Venta</h3>
                <p>${{ "%.2f"|format(promedio_venta) }}</p>
            </div>
        </div>

        <div class="charts-container">
            <!-- Gráfico de Ventas por Cliente -->
            <div class="chart-box">
                <h3>Ventas por Cliente</h3>
                <label for="chartTypeClientes">Selecciona el tipo de gráfico:</label>
                <select id="chartTypeClientes">
                    <option value="line">Línea</option>
                    <option value="doughnut">Dona</option>
                    <option value="radar">Radar</option>
                    <option value="bar">Barra</option>
                </select>
                <canvas id="clientesChart"></canvas>
            </div>
        
            <!-- Gráfico de Ventas por Mes -->
            <div class="chart-box">
                <h3>Ventas por Mes</h3>
                <label for="chartTypeMeses">Selecciona el tipo de gráfico:</label>
                <select id="chartTypeMeses">
                    <option value="line">Línea</option>
                    <option value="doughnut">Dona</option>
                    <option value="radar">Radar</option>
                    <option value="bar">Barra</option>
                </select>
                <canvas id="mesesChart"></canvas>
            </div>
        
            <!-- Gráfico de IVA Totales -->
            <div class="chart-box">
                <h3>IVA Totales</h3>
                <label for="chartTypeIVA">Selecciona el tipo de gráfico:</label>
                <select id="chartTypeIVA">
                    <option value="line">Línea</option>
                    <option value="doughnut">Dona</option>
                    <option value="radar">Radar</option>
                    <option value="bar">Barra</option>
                </select>
                <canvas id="ivaChart"></canvas>
            </div>
        </div>

        
        <script>

                    // Alternar visibilidad de la lista de clientes al hacer clic en el texto
                    document.getElementById('selected-client').addEventListener('click', function(event) {
                        const clientesList = document.getElementById('clientes-list');
                        clientesList.classList.toggle('show');
                        event.stopPropagation(); // Evita que el clic se propague y cierre el desplegable
                    });
                
                    // Manejar la selección de clientes al hacer clic en el nombre
                    document.querySelectorAll('.checkbox-item').forEach(item => {
                    item.addEventListener('click', function(event) {
                        const checkbox = this.querySelector('input[type="checkbox"]');
                        checkbox.checked = !checkbox.checked;
                        this.classList.toggle('selected');

                        // Actualizar la lista de clientes seleccionados
                        const selectedClients = Array.from(document.querySelectorAll('.checkbox-item.selected'))
                            .map(item => item.dataset.cliente);
                        document.getElementById('selected-client').textContent = 
                            selectedClients.length ? selectedClients.join(', ') : 'Selecciona clientes';
                        event.stopPropagation();
                        });
                    });
                
                    // Evitar que la lista de clientes se cierre al hacer clic en un elemento dentro de la lista
                    document.getElementById('clientes-list').addEventListener('click', function(event) {
                        event.stopPropagation();
                    });
                
                    // Cerrar la lista cuando se hace clic fuera de ella
                    document.addEventListener('click', function(event) {
                        const clientesList = document.getElementById('clientes-list');
                        if (!event.target.closest('#selected-client') && !clientesList.contains(event.target)) {
                            clientesList.classList.remove('show');
                        }
                    });
                

            // Función para crear y actualizar gráficos
            function createChart(ctx, type, labels, data, label) {
                return new Chart(ctx, {
                    type: type,
                    data: {
                        labels: labels,
                        datasets: [{
                            label: label,
                            data: data,
                            backgroundColor: [
                                'rgba(75, 192, 192, 0.2)',
                                'rgba(255, 159, 64, 0.2)',
                                'rgba(153, 102, 255, 0.2)',
                                'rgba(255, 206, 86, 0.2)',
                                'rgba(54, 162, 235, 0.2)',
                                'rgba(255, 99, 132, 0.2)'
                            ],
                            borderColor: [
                                'rgba(75, 192, 192, 1)',
                                'rgba(255, 159, 64, 1)',
                                'rgba(153, 102, 255, 1)',
                                'rgba(255, 206, 86, 1)',
                                'rgba(54, 162, 235, 1)',
                                'rgba(255, 99, 132, 1)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: { beginAtZero: true }
                        }
                    }
                });
            }
        
            // Gráfico Ventas por Cliente
            const ctxClientes = document.getElementById('clientesChart').getContext('2d');
            let clientesChart = createChart(ctxClientes, 'line', Object.keys({{ ventas_por_cliente | tojson }}), Object.values({{ ventas_por_cliente | tojson }}), 'Ventas por Cliente');
        
            document.getElementById('chartTypeClientes').addEventListener('change', function() {
                const newType = this.value;
                clientesChart.destroy();
                clientesChart = createChart(ctxClientes, newType, Object.keys({{ ventas_por_cliente | tojson }}), Object.values({{ ventas_por_cliente | tojson }}), 'Ventas por Cliente');
            });
        
            // Gráfico Ventas por Mes
            const ctxMeses = document.getElementById('mesesChart').getContext('2d');
            let mesesChart = createChart(ctxMeses, 'line', Object.keys({{ ventas_por_mes | tojson }}), Object.values({{ ventas_por_mes | tojson }}), 'Ventas por Mes');
        
            document.getElementById('chartTypeMeses').addEventListener('change', function() {
                const newType = this.value;
                mesesChart.destroy();
                mesesChart = createChart(ctxMeses, newType, Object.keys({{ ventas_por_mes | tojson }}), Object.values({{ ventas_por_mes | tojson }}), 'Ventas por Mes');
            });
        
            // Gráfico IVA Totales
            const ctxIVA = document.getElementById('ivaChart').getContext('2d');
            let ivaChart = createChart(ctxIVA, 'line', Object.keys({{ iva_totales | tojson }}), Object.values({{ iva_totales | tojson }}), 'IVA Totales');
        
            document.getElementById('chartTypeIVA').addEventListener('change', function() {
                const newType = this.value;
                ivaChart.destroy();
                ivaChart = createChart(ctxIVA, newType, Object.keys({{ iva_totales | tojson }}), Object.values({{ iva_totales | tojson }}), 'IVA Totales');
            });
        </script>
        
</body>
</html>